name: Free VNC/RDP (Full HD) + Auto-Restart

on:
  workflow_dispatch:
  schedule:
    # Ch·∫°y m·ªói 5 gi·ªù ƒë·ªÉ kh·ªüi ƒë·ªông l·∫°i tr∆∞·ªõc khi phi√™n 6 gi·ªù k·∫øt th√∫c.
    - cron: '0 */5 * * *' 

jobs:
  run-vnc-session:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # Gi·ªõi h·∫°n 5 gi·ªù 50 ph√∫t

    steps:
    - name: ‚¨áÔ∏è Kh√¥i ph·ª•c D·ªØ li·ªáu Quan tr·ªçng (Persistence)
      uses: actions/download-artifact@v4
      with:
        name: persistent-data
        path: ${{ github.workspace }}/data
        
    - name: ‚öôÔ∏è C√†i ƒë·∫∑t M√¥i tr∆∞·ªùng Desktop v√† VNC (Full HD 1920x1080)
      run: |
        # T·∫°o th∆∞ m·ª•c d·ªØ li·ªáu n·∫øu ch∆∞a c√≥
        mkdir -p ${{ github.workspace }}/data
        
        # C·∫≠p nh·∫≠t v√† c√†i ƒë·∫∑t c√°c g√≥i c·∫ßn thi·∫øt
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver websockify gnome-terminal wget
        
        # Thi·∫øt l·∫≠p M·∫≠t kh·∫©u VNC (B·∫ÆT BU·ªòC PH·∫¢I THAY ƒê·ªîI M·∫¨T KH·∫®U N√ÄY!)
        VNC_PASS="depchai" 
        echo "$VNC_PASS" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        
        # Thi·∫øt l·∫≠p file kh·ªüi ƒë·ªông XFCE4
        cat << EOF > ~/.vnc/xstartup
        #!/bin/bash
        xrdb $HOME/.Xresources
        startxfce4 &
        EOF
        chmod +x ~/.vnc/xstartup
        
        # Kh·ªüi ƒë·ªông VNC Server v·ªõi ƒë·ªô ph√¢n gi·∫£i Full HD (1920x1080)
        vncserver :1 -geometry 1920x1080 -depth 24 
        
        # Kh·ªüi ƒë·ªông websockify (noVNC Proxy) tr√™n c·ªïng 6080
        websockify 6080 localhost:5901 --web /usr/share/novnc/ &

    - name: ‚òÅÔ∏è T·∫£i v√† C·∫•u h√¨nh Cloudflare Tunnel (cloudflared)
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: üöÄ Ch·∫°y Cloudflare Tunnel v√† T·∫°o Link Truy C·∫≠p
      env:
        TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        TUNNEL_NAME: ${{ secrets.TUNNEL_NAME }} # L·∫•y t√™n tunnel t·ª´ GitHub Secret
        CF_HOSTNAME: vnc.depchai5.qzz.io # V√≠ d·ª•: THAY TH·∫æ b·∫±ng Hostname B·∫†N ƒê√É C·∫§U H√åNH!
        VNC_URL: https://${{ env.CF_HOSTNAME }}/vnc_auto.html
      run: |
        # Ch·∫°y Cloudflare Tunnel
        /usr/local/bin/cloudflared tunnel run --token $TUNNEL_TOKEN ${{ env.TUNNEL_NAME }} &
        
        # Ghi URL truy c·∫≠p ra GitHub Workflow Summary
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "## üîó Th√¥ng Tin K·∫øt N·ªëi noVNC (FULL HD)" >> $GITHUB_STEP_SUMMARY
        echo "- **URL noVNC:** [Truy c·∫≠p t·∫°i ƒë√¢y](${{ env.VNC_URL }})" >> $GITHUB_STEP_SUMMARY
        echo "- **M·∫≠t Kh·∫©u VNC:** YourSecurePassword123" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        
        # Gi·ªØ job ch·∫°y trong th·ªùi gian d√†i.
        echo "Duy tr√¨ phi√™n l√†m vi·ªác... (T·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i sau 5 gi·ªù)"
        sleep 21000 
        
    - name: ‚¨ÜÔ∏è L∆∞u D·ªØ li·ªáu quan tr·ªçng (Persistence)
      if: always() # Lu√¥n ch·∫°y b∆∞·ªõc n√†y d√π job th·∫•t b·∫°i
      uses: actions/upload-artifact@v4
      with:
        name: persistent-data
        path: ${{ github.workspace }}/data/
        retention-days: 1 # Gi·ªØ Artifact trong 1 ng√†y
