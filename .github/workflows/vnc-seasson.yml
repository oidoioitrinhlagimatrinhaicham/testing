name: Final VNC/RDP (Full HD) + Auto-Restart

on:
  workflow_dispatch:
  schedule:
    # Ch·∫°y m·ªói 5 gi·ªù ƒë·ªÉ t·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i
    - cron: '0 */5 * * *' 

jobs:
  run-vnc-session:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
    - name: ‚¨áÔ∏è Kh√¥i ph·ª•c D·ªØ li·ªáu Quan tr·ªçng (Persistence)
      # CH·ªñ S·ª¨A L·ªñI: B·ªè qua l·ªói n·∫øu Artifact ch∆∞a t·ªìn t·∫°i (l·∫ßn ch·∫°y ƒë·∫ßu ti√™n)
      uses: actions/download-artifact@v4
      id: download-data
      continue-on-error: true # <-- Th√™m d√≤ng n√†y ƒë·ªÉ Job kh√¥ng d·ª´ng l·∫°i khi kh√¥ng t√¨m th·∫•y Artifact
      with:
        name: persistent-data
        path: ${{ github.workspace }}/data
        
    - name: ‚öôÔ∏è C√†i ƒë·∫∑t M√¥i tr∆∞·ªùng Desktop v√† VNC (Full HD 1920x1080)
      run: |
        mkdir -p ${{ github.workspace }}/data
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver websockify gnome-terminal wget
        
        # CH·ªñ S·ª¨A M·∫¨T KH·∫®U: ƒê·∫∂T L·∫†I M·∫¨T KH·∫®U N√ÄY
        VNC_PASS="YourNewSecurePassword123" 
        echo "$VNC_PASS" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        
        vncserver :1 -geometry 1920x1080 -depth 24 
        websockify 6080 localhost:5901 --web /usr/share/novnc/ &

    - name: ‚òÅÔ∏è T·∫£i v√† C·∫•u h√¨nh Cloudflare Tunnel (cloudflared)
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: üöÄ Ch·∫°y Cloudflare Tunnel v√† T·∫°o Link Truy C·∫≠p
      env:
        # L·∫•y c√°c gi√° tr·ªã t·ª´ GitHub Secrets
        TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        TUNNEL_NAME: ${{ secrets.TUNNEL_NAME }} 
        # Gi√° tr·ªã Hostname c·ªßa b·∫°n
        CF_HOSTNAME: ${{ secrets.CF_HOSTNAME }}
        VNC_URL: https://${{ secrets.CF_HOSTNAME }}/vnc_auto.html
      run: |
        /usr/local/bin/cloudflared tunnel run --token $TUNNEL_TOKEN ${{ env.TUNNEL_NAME }} &
        
        # Xu·∫•t URL ra Summary
        echo "## üîó Th√¥ng Tin K·∫øt N·ªëi noVNC (FULL HD)" >> $GITHUB_STEP_SUMMARY
        echo "- **URL noVNC:** [Truy c·∫≠p t·∫°i ƒë√¢y](${{ env.VNC_URL }})" >> $GITHUB_STEP_SUMMARY
        echo "- **M·∫≠t Kh·∫©u VNC:** YourNewSecurePassword123" >> $GITHUB_STEP_SUMMARY
        
        # Duy tr√¨ k·∫øt n·ªëi
        sleep 21000 
        
    - name: ‚¨ÜÔ∏è L∆∞u D·ªØ li·ªáu quan tr·ªçng (Persistence)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: persistent-data
        path: ${{ github.workspace }}/data/
        retention-days: 1
