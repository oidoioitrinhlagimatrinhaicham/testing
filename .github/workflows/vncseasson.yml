name: Final VNC/RDP (Full HD) - NO PERSISTENCE

on:
  workflow_dispatch:
  schedule:
    # T·ª± ƒë·ªông kh·ªüi ƒë·ªông l·∫°i m·ªói 5 gi·ªù
    - cron: '0 */5 * * *' 

jobs:
  run-vnc-session:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # Gi·ªõi h·∫°n 5 gi·ªù 50 ph√∫t

    steps:
    
    # B∆∞·ªõc Kh√¥i ph·ª•c D·ªØ li·ªáu ƒë√£ B·ªä X√ìA (‚¨áÔ∏è)

    - name: ‚öôÔ∏è C√†i ƒë·∫∑t M√¥i tr∆∞·ªùng Desktop v√† VNC (Full HD 1920x1080)
      run: |
        sudo apt update
        sudo apt install -y xfce4 xfce4-goodies tightvncserver websockify gnome-terminal wget
        
        # CH·ªñ S·ª¨A L·ªñI: T·∫°o th∆∞ m·ª•c .vnc tr∆∞·ªõc khi t·∫°o file passwd
        mkdir -p ~/.vnc 
        
        # ƒê·∫∂T L·∫†I M·∫¨T KH·∫®U C·ª¶A B·∫†N!
        VNC_PASS="YourNewSecurePassword123" 
        echo "$VNC_PASS" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        
        # Thi·∫øt l·∫≠p VNC v√† kh·ªüi ƒë·ªông Full HD
        cat << EOF > ~/.vnc/xstartup
        #!/bin/bash
        xrdb $HOME/.Xresources
        startxfce4 &
        EOF
        chmod +x ~/.vnc/xstartup
        
        vncserver :1 -geometry 1920x1080 -depth 24 
        
        # Kh·ªüi ƒë·ªông noVNC Proxy
        websockify 6080 localhost:5901 --web /usr/share/novnc/ &

    - name: ‚òÅÔ∏è T·∫£i v√† C·∫•u h√¨nh Cloudflare Tunnel (cloudflared)
      run: |
        wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: üöÄ Ch·∫°y Cloudflare Tunnel v√† T·∫°o Link Truy C·∫≠p
      env:
        # L·∫•y c√°c gi√° tr·ªã t·ª´ GitHub Secrets
        TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
        TUNNEL_NAME: ${{ secrets.TUNNEL_NAME }} 
        CF_HOSTNAME: ${{ secrets.CF_HOSTNAME }}
        VNC_URL: https://${{ secrets.CF_HOSTNAME }}/vnc_auto.html
      run: |
        /usr/local/bin/cloudflared tunnel run --token $TUNNEL_TOKEN ${{ env.TUNNEL_NAME }} &
        
        # Xu·∫•t URL ra Summary
        echo "## üîó Th√¥ng Tin K·∫øt N·ªëi noVNC (FULL HD)" >> $GITHUB_STEP_SUMMARY
        echo "- **URL noVNC:** [Truy c·∫≠p t·∫°i ƒë√¢y](${{ env.VNC_URL }})" >> $GITHUB_STEP_SUMMARY
        echo "- **M·∫≠t Kh·∫©u VNC:** YourNewSecurePassword123" >> $GITHUB_STEP_SUMMARY
        
        # Duy tr√¨ k·∫øt n·ªëi
        sleep 21000 
        
    # B∆∞·ªõc L∆∞u D·ªØ li·ªáu ƒë√£ B·ªä X√ìA (‚¨ÜÔ∏è)
